<div class="cart-container">
  <!-- Flash Message Container -->
  <% if flash.any? %>
  <div id="flash-container">
    <% flash.each do |type, message| %>
      <div class="flash-message flash-<%= type %>"><%= message %></div>
    <% end %>
  </div>
<% end %>

  <h1 class="cart-title">Shopping Cart</h1>
  <% count = @cart.cart_items.count %>
  <h2 class="cart-subtitle"><%= count %> <%= count == 1 ? 'item' : 'items' %></h2>

  <ul class="cart-items">
    <% @cart.cart_items.includes(:product).each do |item| %>
      <li class="cart-item">
        <%= image_tag item.product.image, alt: item.product.name, class: "cart-item-image" %>
        <div class="cart-item-details">
          <p><strong><%= item.product.name %></strong></p>
          <p><%= item.product.description %></p>
          <p class="cart-item-price">$<%= item.product.price %></p>
          <div class="cart-item-actions">
            <%= button_to "Remove", cart_item_path(item), method: :delete, class: "btn btn-danger", data: { turbo: false } %>
            <% if item.product.product_type == 'BuildPC' %>
              <%= link_to 'Edit', edit_build_pc_path(item.product.build_pc), class: 'btn btn-outline-primary btn-sm' %>
            <% end %>
          </div>
        </div>
      </li>
    <% end %>
  </ul>

  <div class="cart-footer">
    <%= button_to "Clear Cart", cart_path(@cart), method: :delete, class: "btn btn-warning", data: { turbo: false } %>
    <h3 class="cart-total">Total: $<%= @cart.cart_items.sum { |item| item.product.price } %></h3>
    <button onclick="document.getElementById('checkout-popup').style.display='block'" class="btn btn-success checkout-btn">
      Proceed to Checkout
    </button>
  </div>
</div>

<!-- Checkout Popup -->
<div id="checkout-popup" class="checkout-modal">
  <div class="checkout-box">
    <h2>Checkout</h2>

    <%= form_with url: checkout_path, method: :post, local: true do %>
      <div class="form-group">
        <label>Card Number</label>
        <%= text_field_tag :card_number, nil, maxlength: 16, required: true %>
      </div>

      <div class="form-group">
        <label>Expiration Date</label>
        <%= text_field_tag :exp_date, nil, placeholder: "MM/YY", required: true %>
      </div>

      <div class="form-group">
        <label>Security Code (CVV)</label>
        <%= text_field_tag :cvv, nil, maxlength: 3, required: true %>
      </div>

      <div class="form-actions">
        <%= submit_tag "Pay", class: "btn btn-primary" %>
        <button type="button" onclick="document.getElementById('checkout-popup').style.display='none'" class="btn btn-secondary">
          Cancel
        </button>
      </div>
    <% end %>
  </div>
</div>

<!-- Auto-fade Flash Script -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const flash = document.querySelector(".flash-message");
    if (flash) {
      setTimeout(() => {
        flash.style.opacity = "0";
        setTimeout(() => flash.remove(), 500); 
      }, 3000); 
    }
  });
</script>
